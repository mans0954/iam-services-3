use openiam;


DELIMITER $$

DROP PROCEDURE IF EXISTS LANGUAGE_SCHEMA_CHANGE$$

CREATE PROCEDURE LANGUAGE_SCHEMA_CHANGE()
	BEGIN
		IF EXISTS (SELECT * FROM information_schema.columns WHERE table_schema='openiam' and table_name = 'LANGUAGE' AND column_name = 'LOCALE') THEN
			ALTER TABLE LANGUAGE DROP COLUMN LOCALE;
    END IF;

		IF NOT EXISTS (SELECT * FROM information_schema.columns WHERE table_schema='openiam' and table_name = 'LANGUAGE' AND column_name = 'LANGUAGE_CODE') THEN
			ALTER TABLE LANGUAGE ADD COLUMN LANGUAGE_CODE varchar(2) NOT NULL;

			UPDATE LANGUAGE SET LANGUAGE_CODE='en' WHERE ID='1';
			UPDATE LANGUAGE SET LANGUAGE_CODE='de' WHERE ID='2';
			UPDATE LANGUAGE SET LANGUAGE_CODE='fr' WHERE ID='3';
			UPDATE LANGUAGE SET LANGUAGE_CODE='es' WHERE ID='4';
			UPDATE LANGUAGE SET LANGUAGE_CODE='it' WHERE ID='5';
			UPDATE LANGUAGE SET LANGUAGE_CODE='nl' WHERE ID='6';
			UPDATE LANGUAGE SET LANGUAGE_CODE='pt' WHERE ID='7';

 		END IF;
	END$$
DELIMITER ;

call LANGUAGE_SCHEMA_CHANGE();

DROP PROCEDURE LANGUAGE_SCHEMA_CHANGE;

DROP TABLE IF EXISTS LANGUAGE_LOCALE;

CREATE TABLE LANGUAGE_LOCALE (
  ID varchar(32) NOT NULL,
  LANGUAGE_ID varchar(32) NOT NULL,
  LOCALE varchar(32) NOT NULL,
  CONSTRAINT LANGUAGE_LOCALE_LANGUAGE_FK FOREIGN KEY (LANGUAGE_ID) REFERENCES LANGUAGE(ID),
  CONSTRAINT LANGUAGE_LOCALE_UNIQUE UNIQUE(LOCALE)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO LANGUAGE_LOCALE (ID, LANGUAGE_ID, LOCALE) VALUES 
	('1', '1', 'en_EN'),
	('2', '1', 'en_US'),
	('3', '1', 'en_GB'),
	('4', '2', 'de_DE'),
	('5', '3', 'fr_FR'),
	('6', '4', 'es_ES'),
	('7', '5', 'it_IT'),
	('8', '6', 'nl_NL'),
	('9', '7', 'pt_PT');