machine:
  java:
    version: oraclejdk8
  services:
    - rabbitmq-server
dependencies:
  pre:
    - sudo apt-get install dos2unix
    - mysql -u root --execute="SET PASSWORD FOR 'root'@'localhost' = PASSWORD('passwd00')"
    - sudo apt-add-repository -y 'deb http://ppa.launchpad.net/ondrej/mysql-experimental/ubuntu precise main'
    - sudo apt-get update
    - sudo apt-get install bash
    - sudo rabbitmqctl add_vhost openiam_am
    - sudo rabbitmqctl add_vhost openiam_idm
    - sudo rabbitmqctl add_vhost openiam_audit
    - sudo rabbitmqctl add_vhost openiam_common
    - sudo rabbitmqctl add_vhost openiam_connector
    - sudo rabbitmqctl add_vhost openiam_activiti
    - sudo rabbitmqctl add_vhost openiam_user
    - sudo rabbitmqctl add_user openiam passwd00
    - sudo rabbitmqctl set_permissions -p openiam_am openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_idm openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_audit openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_common openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_connector openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_activiti openiam ".*" ".*" ".*"
    - sudo rabbitmqctl set_permissions -p openiam_user openiam ".*" ".*" ".*"
    - cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.5.6/plugins;sudo wget https://www.rabbitmq.com/community-plugins/v3.5.x/rabbitmq_delayed_message_exchange-0.0.1-rmq3.5.x-9bf265e4.ez;sudo rabbitmq-plugins enable rabbitmq_delayed_message_exchange
    - sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server-5.6
    - wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.3/elasticsearch-2.4.3.tar.gz
    - tar -xvf elasticsearch-2.4.3.tar.gz
    - sudo cp elasticsearch.yml elasticsearch-2.4.3/config/elasticsearch.yml
    - /bin/sh elasticsearch-2.4.3/bin/elasticsearch -d
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/
    - cd conf; sudo /bin/sh setup.sh
    - cd /tmp/openiam/schema/mysql; sudo ./execute.sh passwd00 new_install
  override:
    - mvn install -s conf/settings.xml
    - mvn package spring-boot:repackage -f openiam-esb/pom.xml
test:
  post:
    - sudo nohup bash -c "sudo -u ubuntu java -Xms512m -Xmx1024m -XX:ReservedCodeCacheSize=64m -Dconfpath=/data/openiam -jar /home/ubuntu/iam-services/openiam-esb/target/openiam-esb.jar > /var/log/esb.log &"
    - sleep 300
    - mvn test -DskipTests=false -DargLine="-Xmx1024m" -s conf/settings.xml:
        timeout: 3600
        parallel: true
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
deployment:
  development:
    branch: development
    commands:
       - bash conf/deploy.sh