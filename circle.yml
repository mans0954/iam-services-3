machine:
  java:
    version: oraclejdk8

dependencies:
  pre:
    - sudo apt-get install dos2unix
  override:
    - mvn install -s conf/settings.xml
    - mvn package spring-boot:repackage -f openiam-esb/pom.xml
    - mvn deploy -s conf/settings.xml
    - ./update_version.sh $(mvn help:evaluate -Dexpression=project.version | grep -v '\[.*')-${CIRCLE_BUILD_NUM}
    - mvn install -s conf/settings.xml
    - mvn package spring-boot:repackage -f openiam-esb/pom.xml
    - mvn deploy -s conf/settings.xml
test:
  post:
    - sudo mkdir -p /data/openiam/conf
    - sudo mkdir -p /etc/chef
    - sudo mkdir -p /opt/openiam/webapps
    - sudo cp conf/client.rb /etc/chef/client.rb
    - sudo cp conf/client.pem /etc/chef/client.pem
    - sudo cp conf/attributes.json /etc/chef/attributes.json
    - sudo chef-client -o openiam-properties::datasource -E DEV
    - sudo chef-client -o openiam-properties::securityconf -E DEV
    - sudo chef-client -o openiam-properties::service-urls -E DEV
    - sudo chef-client -o openiam-conf -E DEV
    - sudo chef-client -o openiam-hazelcast -E DEV -j /etc/chef/attributes.json
    - mysql -u root --execute="SET PASSWORD FOR 'root'@'localhost' = PASSWORD('passwd00')"
    - cd /tmp/openiam/schema/mysql; sudo ./execute.sh passwd00 new_install
    - mvn test -DskipTests=false -DargLine="-Xmx1024m" -s conf/settings.xml:
        timeout: 3600
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;