package org.openiam.idm.srvc.pswd.service;

<<<<<<< HEAD
=======
import org.apache.commons.collections.CollectionUtils;
>>>>>>> RELEASE-3.2.7
import org.apache.commons.lang.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.openiam.am.srvc.dao.AuthProviderDao;
import org.openiam.am.srvc.dao.ContentProviderDao;
import org.openiam.am.srvc.domain.AuthProviderEntity;
import org.openiam.am.srvc.domain.ContentProviderEntity;
import org.openiam.base.SysConfiguration;
import org.openiam.dozer.converter.PolicyDozerConverter;
import org.openiam.idm.srvc.org.domain.OrganizationEntity;
import org.openiam.idm.srvc.org.service.OrganizationDAO;
<<<<<<< HEAD
import org.openiam.idm.srvc.policy.domain.PolicyEntity;
import org.openiam.idm.srvc.policy.dto.Policy;
import org.openiam.idm.srvc.policy.service.PolicyDataService;
=======
import org.openiam.idm.srvc.policy.domain.PolicyObjectAssocEntity;
import org.openiam.idm.srvc.policy.dto.PasswordPolicyAssocSearchBean;
import org.openiam.idm.srvc.policy.dto.Policy;
import org.openiam.idm.srvc.policy.service.PolicyDataService;
import org.openiam.idm.srvc.policy.service.PolicyObjectAssocDAO;
import org.openiam.idm.srvc.role.domain.RoleEntity;
import org.openiam.idm.srvc.role.dto.Role;
>>>>>>> RELEASE-3.2.7
import org.openiam.idm.srvc.user.domain.UserEntity;
import org.openiam.idm.srvc.user.service.UserDataService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * Created with IntelliJ IDEA.
 * User: alexander
 * Date: 10/3/13
 * Time: 11:21 PM
 * To change this template use File | Settings | File Templates.
 */
@Service
public class PasswordPolicyProviderImpl implements PasswordPolicyProvider {
    private static final Log log = LogFactory.getLog(PasswordServiceImpl.class);

    @Autowired
    private ContentProviderDao contentProviderDAO;
    @Autowired
    protected OrganizationDAO organizationDAO;
    @Autowired
    protected org.openiam.idm.srvc.role.service.RoleDAO roleDAO;
    @Autowired
    protected UserDataService userManager;
    
    @Autowired
    private AuthProviderDao authProviderDAO;

    @Autowired
    private SysConfiguration sysConfiguration;
    
    @Autowired
    private PolicyDozerConverter policyDozerConverter;

    @Override
<<<<<<< HEAD
    @Transactional
=======
    public Policy getPasswordPolicyByUser(PasswordPolicyAssocSearchBean searchBean) {
        return getPasswordPolicyByUser(userManager.getUser(searchBean.getUserId()), searchBean.getManagedSystemId());
    }

    @Override
    public Policy getPasswordPolicyByUser(UserEntity user, String managedSystemId) {
        // Find a password policy for this user
        // order of search, type, classification, domain, global

        PolicyObjectAssocEntity policyAssocEntity = null;

        log.info("Looking for associate by managedSystemId.");
        if (StringUtils.isNotBlank(managedSystemId)) {
            policyAssocEntity = policyObjectAssocDao.findAssociationByLevel(
                    "MANAGED_SYSTEM", managedSystemId);
            log.info(String.format("Association found: %s", policyAssocEntity));
            if (policyAssocEntity != null) {
                return getPolicy(policyAssocEntity);
            }
        }

        log.info("Looking for associate by metadata type.");
        log.info(String.format("User type =%s", user.getId()));
        if (user.getType() != null) {
            policyAssocEntity = policyObjectAssocDao.findAssociationByLevel(
                    "USER_TYPE", user.getType().getId());
            log.info(String.format("Association found: %s", policyAssocEntity));
            if (policyAssocEntity != null) {
                return getPolicy(policyAssocEntity);
            }
        }


        if (user.getId() != null) {
            //  set by ORGANIZATION
            List<OrganizationEntity> orgEntity = organizationDAO
                    .getOrganizationsForUser(user.getId(), null, -1, -1);
            if (CollectionUtils.isNotEmpty(orgEntity)) {
                for (OrganizationEntity organization : orgEntity) {
                    log.info("Looking for associate by organization.");
                    policyAssocEntity = policyObjectAssocDao
                            .findAssociationByLevel("ORGANIZATION",
                                    organization.getId());
                    log.info(String.format("Association found: %s", policyAssocEntity));
                    if (policyAssocEntity != null) {
                        log.info("PolicyAssoc found=" + policyAssocEntity);
                        break;
                    }
                }
                if (policyAssocEntity != null) {
                    return getPolicy(policyAssocEntity);
                }
            }
            //  set by ROLES
            List<RoleEntity> roles = roleDAO.getRolesForUser(user.getId(), null, -1, -1);
            if (CollectionUtils.isNotEmpty(roles)) {
                for (RoleEntity role : roles) {
                    log.info("Looking for associate by roles.");
                    policyAssocEntity = policyObjectAssocDao
                            .findAssociationByLevel("ROLE",
                                    role.getId());
                    log.info(String.format("Association found: %s", policyAssocEntity));
                    if (policyAssocEntity != null) {
                        log.info("PolicyAssoc found=" + policyAssocEntity);
                        break;
                    }
                }
                if (policyAssocEntity != null) {
                    return getPolicy(policyAssocEntity);
                }
            }
        }

        log.info("Using global association password policy.");
        // did not find anything - get the global policy
        return getGlobalPasswordPolicy();
    }

    private Policy getPolicy(PolicyObjectAssocEntity policyAssoc) {
        log.info("Retreiving policyId=" + policyAssoc.getPolicyId());
        return policyDataService.getPolicy(policyAssoc.getPolicyId());
    }


    /**
     * Returns the global password policy
     *
     * @return
     */
    @Override
>>>>>>> RELEASE-3.2.7
    public Policy getGlobalPasswordPolicy() {
    	Policy retVal = null;
    	final AuthProviderEntity authProvider = authProviderDAO.findById(sysConfiguration.getDefaultAuthProviderId());
    	if(authProvider != null) {
    		final PolicyEntity policyEntity = authProvider.getPolicy();
    		if(policyEntity != null) {
    			retVal = policyDozerConverter.convertToDTO(policyEntity, true);
    		}
    	}
    	return retVal;
    }
    
	@Override
	@Transactional
	public Policy getPasswordPolicyByUser(String userId,
			String contentProviderId) {
		return getPasswordPolicyByUser(userManager.getUser(userId), contentProviderId);
	}
	
	@Override
	@Transactional
	public Policy getPasswordPolicyByUser(final UserEntity user, final String contentProviderId) {
		Policy retVal = null;
		if(StringUtils.isNotBlank(contentProviderId)) {
			final ContentProviderEntity contentProvider = contentProviderDAO.findById(contentProviderId);
			if(contentProvider != null) {
				final AuthProviderEntity authProvider = contentProvider.getAuthProvider();
				if(authProvider != null) {
					final PolicyEntity policyEntity = authProvider.getPolicy();
					if(policyEntity != null) {
						retVal = policyDozerConverter.convertToDTO(policyEntity, true);
					}
				}
			}
		}
		if(retVal == null) {
			retVal = getGlobalPasswordPolicy();
		}
		return retVal;
	}
}
